# Template: Self-hosted RSS-to-email via SMTP provider (DISABLED by default)
#
# Usage:
# 1) Pick an SMTP provider (Mailgun, AWS SES, Postmark, Brevo SMTP, etc.).
# 2) Add repository secrets:
#    - SMTP_HOST, SMTP_PORT, SMTP_USERNAME, SMTP_PASSWORD
#    - SMTP_FROM, SMTP_FROM_NAME (optional), SMTP_TO (comma-separated list for testing)
#    - FEED_URL (default: https://<user>.github.io/feed.xml)
# 3) Uncomment the schedule to enable periodic sends.
# 4) Replace the "Discover new items" step with your own logic if you want digests.

name: RSS to Email (self-host)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 14 * * *'  # daily at 14:00 UTC

jobs:
  send:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout (no code needed, but keeps defaults)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install feedparser Jinja2

      - name: Discover new items
        id: discover
        env:
          FEED_URL: ${{ secrets.FEED_URL }}
        run: |
          python - << 'PY'
import os, sys, textwrap
import feedparser

feed_url = os.environ.get('FEED_URL')
if not feed_url:
    print('::warning::FEED_URL secret not set; defaulting to https://example.github.io/feed.xml')
    feed_url = 'https://example.github.io/feed.xml'

feed = feedparser.parse(feed_url)
if feed.bozo:
    print('::error::Failed to parse feed:', feed.bozo_exception)
    sys.exit(1)

entries = feed.entries[:3]  # latest 3 for testing
if not entries:
    print('No entries in feed; exiting.'); sys.exit(0)

def fmt(e):
    title = e.get('title', '(untitled)')
    link = e.get('link', '')
    summary = e.get('summary', '')
    return f"<p><strong><a href='{link}'>{title}</a></strong><br>{summary}</p>"

html = "\n".join(fmt(e) for e in entries)
print('EMAIL_HTML<<\n' + html + '\nEMAIL_HTML')
PY

      - name: Extract content
        id: content
        run: |
          html=$(sed -n '/EMAIL_HTML<</,$p' $GITHUB_STEP_SUMMARY | sed '1d')
          echo "html<<EOF" >> $GITHUB_OUTPUT
          echo "$html" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Send via SMTP (test)
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "New posts from RSS (test)"
          from: ${{ secrets.SMTP_FROM }}
          to: ${{ secrets.SMTP_TO }}
          content_type: text/html
          convert_markdown: false
          body: ${{ steps.content.outputs.html }}

# Notes:
# - For production, implement delta tracking (store last sent GUID) using a small
#   state file in the repo or an external KV (S3, Redis, etc.) to avoid resending.
# - You can migrate to a digest cadence and template with Jinja2.
